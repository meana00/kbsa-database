<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국 초자연 현상 관리국</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #111827; color: #E5E7EB; }
        .header-glitch { animation: glitch 1s linear infinite; }
        @keyframes glitch { 2%,64% { transform: translate(2px,0) skew(0deg); } 4%,60% { transform: translate(-2px,0) skew(0deg); } 62% { transform: translate(0,0) skew(5deg); } }
        .header-glitch:before, .header-glitch:after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111827; overflow: hidden; }
        .header-glitch:before { left: 2px; text-shadow: -2px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim 5s infinite linear alternate-reverse; }
        .header-glitch:after { left: -2px; text-shadow: -2px 0 #00fff9, 2px 2px #ff00c1; clip: rect(85px, 450px, 90px, 0); animation: glitch-anim2 5s infinite linear alternate-reverse; }
        @keyframes glitch-anim { 0% { clip: rect(42px, 9999px, 44px, 0); } 10% { clip: rect(17px, 9999px, 96px, 0); } 20% { clip: rect(50px, 9999px, 52px, 0); } 30% { clip: rect(25px, 9999px, 70px, 0); } 40% { clip: rect(40px, 9999px, 62px, 0); } 50% { clip: rect(25px, 9999px, 100px, 0); } 60% { clip: rect(65px, 9999px, 80px, 0); } 70% { clip: rect(10px, 9999px, 45px, 0); } 80% { clip: rect(80px, 9999px, 100px, 0); } 90% { clip: rect(20px, 9999px, 75px, 0); } 100% { clip: rect(55px, 9999px, 60px, 0); } }
        @keyframes glitch-anim2 { 0% { clip: rect(15px, 9999px, 99px, 0); } 10% { clip: rect(33px, 9999px, 72px, 0); } 20% { clip: rect(60px, 9999px, 42px, 0); } 30% { clip: rect(45px, 9999px, 80px, 0); } 40% { clip: rect(70px, 9999px, 52px, 0); } 50% { clip: rect(35px, 9999px, 90px, 0); } 60% { clip: rect(75px, 9999px, 70px, 0); } 70% { clip: rect(20px, 9999px, 55px, 0); } 80% { clip: rect(90px, 9999px, 100px, 0); } 90% { clip: rect(40px, 9999px, 85px, 0); } 100% { clip: rect(65px, 9999px, 70px, 0); } }
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.05)); background-size: 100% 4px; animation: scan 2s linear infinite; }
        @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100px; } }
        .object-card { border: 1px solid #374151; transition: all 0.3s ease; }
        .object-card:hover { border-color: #F87171; box-shadow: 0 0 15px rgba(248, 113, 113, 0.5); transform: translateY(-5px); }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="scanlines"></div>
    <div class="container mx-auto p-4 md:p-8">
        <!-- 헤더, 네비게이션, 메인 컨텐츠 HTML은 이전과 동일합니다 -->
        <header class="text-center mb-12 relative">
            <div class="inline-block p-4 border-2 border-red-500 rounded-lg">
                <h1 class="text-4xl md:text-6xl font-bold text-red-400 tracking-widest relative header-glitch" data-text="KBSA">KBSA</h1>
                <p class="text-lg md:text-xl text-gray-400 mt-2">한국 초자연 현상 관리국</p>
                <p class="text-xs text-gray-500">Korea Bureau of Supernatural Affairs</p>
                <p class="text-sm text-yellow-500 mt-2">[보안 등급: 3등급 인가자]</p>
            </div>
        </header>

        <nav class="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-12 flex justify-center items-center space-x-4 md:space-x-8">
            <a href="#welcome" class="text-gray-300 hover:text-red-400 transition">홈</a>
            <a href="#objects" class="text-gray-300 hover:text-red-400 transition">관리 개체 목록</a>
            <a href="#about" class="text-gray-300 hover:text-red-400 transition">부서 정보</a>
            <button id="addNewReportBtnNav" onclick="openNewReportModal()" class="text-gray-300 hover:text-red-400 transition hidden">신규 보고서 추가</button>
            <button id="adminLoginBtn" onclick="handleAdminClick()" class="text-yellow-400 hover:text-yellow-200 transition border border-yellow-500 px-3 py-1 rounded-md text-sm">관리자 모드</button>
        </nav>

        <main id="main-content">
            <section id="welcome" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-8">
                <h2 id="briefing-date" class="text-2xl font-bold text-red-400 border-b-2 border-red-500 pb-2 mb-4">보안 브리핑</h2>
                <p class="mb-4">3등급 인가자, 환영합니다. 본 데이터베이스는 대한민국 영토 내에서 발견 및 관리 중인 초자연적 개체, 현상, 유물에 대한 정보를 포함하고 있습니다. 모든 정보는 <span class="text-yellow-400 font-bold">1급 기밀</span>로 취급됩니다.</p>
                <button id="seed-data-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-1 px-2 rounded-lg transition">초기 데이터 주입 (DB가 비어있을 때만 사용)</button>
            </section>
            <section id="objects">
                <div class="flex justify-between items-center mb-8">
                     <h2 class="text-3xl font-bold text-gray-300">주요 관리 개체 목록</h2>
                     <button id="addNewEntityBtnMain" onclick="openNewReportModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition hidden">+ 신규 개체 등록</button>
                </div>
                <div id="object-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>
            <section id="about" class="bg-gray-800 border border-gray-700 rounded-lg p-6 mt-12">
                <h2 class="text-2xl font-bold text-red-400 border-b-2 border-red-500 pb-2 mb-4">우리의 임무</h2>
                <p><strong>"우리는 어둠 속에서 싸우며, 빛을 지키기 위해 존재한다."</strong></p>
            </section>
        </main>
        <footer class="text-center text-gray-500 text-sm mt-12 border-t border-gray-700 pt-6">
            <p>&copy; 2025 대한민국 정부. 모든 권리 보유.</p>
        </footer>
    </div>

    <!-- 모달 HTML은 이전과 동일합니다 -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 border border-red-500 rounded-lg p-8 max-w-3xl w-full max-h-screen overflow-y-auto relative"><button onclick="closeModal('reportModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button><div id="reportContent"></div></div></div>
    <div id="formModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 border border-yellow-500 rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto relative"><h2 id="formTitle" class="text-2xl font-bold text-yellow-400 mb-6"></h2><button onclick="closeModal('formModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button><form id="reportForm"><input type="hidden" id="editObjectId" name="editObjectId"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div class="mb-4"><label for="objectId" class="block text-sm font-bold mb-2">개체 번호</label><input type="text" id="objectId" name="objectId" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-yellow-500" required></div><div class="mb-4"><label for="objectAlias" class="block text-sm font-bold mb-2">별칭</label><input type="text" id="objectAlias" name="objectAlias" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-yellow-500" required></div></div><div class="mb-4"><label for="objectLevel" class="block text-sm font-bold mb-2">위험 등급</label><select id="objectLevel" name="objectLevel" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-yellow-500" required><option value="안전">안전</option><option value="경계">경계</option><option value="위험">위험</option><option value="미분류">미분류</option></select></div><div class="mb-4"><label for="objectDescription" class="block text-sm font-bold mb-2">개요 (목록에 표시)</label><textarea id="objectDescription" name="objectDescription" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-yellow-500" required></textarea></div><div class="mb-4"><label for="objectSpecialProcedures" class="block text-sm font-bold mb-2">특수 격리 절차</label><textarea id="objectSpecialProcedures" name="objectSpecialProcedures" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-yellow-500"></textarea></div><div class="mb-4"><label for="objectDetails" class="block text-sm font-bold mb-2">상세 설명</label><textarea id="objectDetails" name="objectDetails" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-yellow-500"></textarea></div><div class="mb-6"><label for="objectAppendix" class="block text-sm font-bold mb-2">부록</label><textarea id="objectAppendix" name="objectAppendix" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 focus:outline-none focus:border-yellow-500"></textarea></div><div class="text-right"><button type="button" onclick="closeModal('formModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition">취소</button><button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition">저장</button></div></form></div></div>
    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 border border-yellow-500 rounded-lg p-8 max-w-sm w-full"><h2 class="text-xl font-bold text-yellow-400 mb-4">관리자 인증</h2><p id="passwordError" class="text-red-500 text-sm mb-4 hidden">비밀번호가 틀렸습니다.</p><input type="password" id="passwordInput" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3 mb-4 focus:outline-none focus:border-yellow-500" placeholder="비밀번호"><div class="text-right"><button type="button" onclick="closeModal('passwordModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition">취소</button><button type="button" onclick="checkPassword()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition">인증</button></div></div></div>
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 border border-red-500 rounded-lg p-8 max-w-sm w-full"><h2 class="text-xl font-bold text-red-400 mb-4">삭제 확인</h2><p id="deleteConfirmText" class="mb-6"></p><div class="text-right"><button type="button" onclick="closeModal('deleteConfirmModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition">취소</button><button type="button" onclick="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">삭제</button></div></div></div>
    <div id="logFormModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-800 border border-green-500 rounded-lg p-8 max-w-xl w-full relative"><h2 id="logFormTitle" class="text-2xl font-bold text-green-400 mb-6"></h2><button onclick="closeModal('logFormModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button><form id="logForm"><input type="hidden" id="logObjectId"><input type="hidden" id="logId"><div class="mb-4"><label for="logAgent" class="block text-sm font-bold mb-2">요원 이름</label><input type="text" id="logAgent" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3" required></div><div class="mb-6"><label for="logContent" class="block text-sm font-bold mb-2">기록 내용</label><textarea id="logContentInput" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded py-2 px-3" required></textarea></div><div class="text-right"><button type="button" onclick="closeModal('logFormModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2">취소</button><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">기록 저장</button></div></form></div></div>

    <!-- Firebase SDK 추가 -->
    <script type="module">
        // Firebase 라이브러리 가져오기
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";

        // =================================================================================
        // TODO: 여기에 1단계에서 복사한 본인의 Firebase 구성 코드를 붙여넣으세요.
        // =================================================================================
const firebaseConfig = {
  apiKey: "AIzaSyDKTXOOGLrMlx6Q5DLK0Fo4igvukkyqExI",
  authDomain: "kbsa-database-project.firebaseapp.com",
  projectId: "kbsa-database-project",
  storageBucket: "kbsa-database-project.firebasestorage.app",
  messagingSenderId: "884730895650",
  appId: "1:884730895650:web:01f73f08ebb24d3cc5997b",
  measurementId: "G-2DPK1B6CNV"
        };
        // =================================================================================

        // Firebase 앱 초기화 및 Firestore 인스턴스 생성
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        const objectsCollection = collection(db, "kbsa-objects");

        // --- 상태 관리 ---
        let adminMode = false;
        let itemToDelete = { type: null, objectId: null, logId: null };
        let objects = []; // 로컬 캐시로 사용할 배열

        // --- 초기 데이터 (DB가 비어있을 경우에만 사용) ---
        const initialObjects = [
            { id: "BSA-001-492-771", alias: "돌아오지 않는 놀이터", level: "안전", description: "경기도 외곽에 위치한 특정 놀이터. 일몰 후 특정 조건에서 진입한 아동이 실종되는 현상.", specialProcedures: "대상 놀이터는 KBSA 제17기지 소속 제3기동대 '땅거미'가 관리한다.", details: "BSA-001은 경기도 ██시 외곽에 위치한 낡은 어린이 놀이터이다.", appendix: "부록 001-A: 회수된 녹음 파일에는 '엄마, 여긴 별이 모래처럼 많아.' 라는 음성이 기록됨.", logs: [ { logId: 1662454123456, date: "2025-07-15", agent: "김민준 요원", content: "초기 격리 절차 완료." } ] },
            { id: "BSA-002-108-345", alias: "웃는 얼굴의 도자기", level: "경계", description: "조선시대 백자로 추정되는 유물. 반경 5m 내의 인간에게 강박적인 행복감을 유발함.", specialProcedures: "BSA-002는 제7기지 제3생물연구동의 전자기 차폐 격리실에 보관한다.", details: "BSA-002는 16세기 조선 백자로 추정되는 높이 30cm의 도자기이다.", appendix: "", logs: [ { logId: 1662454123458, date: "2025-08-20", agent: "이현우 박사", content: "정신 감응파의 정확한 주파수 측정 실패." } ] },
            { id: "BSA-003-881-213", alias: "스스로 쓰는 붓", level: "위험", description: "소유자의 의지와 무관하게 미래의 재앙을 예언한다.", specialProcedures: "BSA-003은 제3기지 최고 보안 등급의 무인 격리실에 보관한다.", details: "BSA-003은 제작자 및 제작 연대 미상의 붓이다.", appendix: "20██년, '██ 대교 붕괴' 예언을 막으려다 더 큰 피해가 발생함.", logs: [] }
        ];

        // --- DOM 요소 ---
        const objectListContainer = document.getElementById('object-list');
        const reportModal = document.getElementById('reportModal');
        const formModal = document.getElementById('formModal');
        const passwordModal = document.getElementById('passwordModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const logFormModal = document.getElementById('logFormModal');
        const reportContent = document.getElementById('reportContent');
        const reportForm = document.getElementById('reportForm');
        const logForm = document.getElementById('logForm');

        // --- 렌더링 함수 (이전과 동일) ---
        function getLevelColor(level) { return { '안전': 'bg-green-800 text-green-200', '경계': 'bg-yellow-800 text-yellow-200', '위험': 'bg-red-800 text-red-200' }[level] || 'bg-gray-700 text-gray-200'; }
        function renderObjects() {
            objectListContainer.innerHTML = objects.map(obj => {
                const adminButtons = adminMode ? `<div class="mt-4 pt-4 border-t border-gray-700 flex justify-end space-x-2"><button onclick="openEditReportModal('${obj.id}')" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded">수정</button><button onclick="openDeleteConfirm('object', '${obj.id}')" class="text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">삭제</button></div>` : '';
                return `<div class="object-card bg-gray-800 rounded-lg p-6 flex flex-col justify-between"><div><div class="flex justify-between items-center mb-2"><h3 class="text-xl font-bold text-red-400">${obj.id}</h3><span class="px-3 py-1 ${getLevelColor(obj.level)} text-sm font-semibold rounded-full">${obj.level}</span></div><p class="text-gray-400 text-sm mb-4"><strong>별칭: ${obj.alias}.</strong> ${obj.description}</p></div><div><button onclick="viewReport('${obj.id}')" class="text-red-400 hover:underline text-left">세부 보고서 열람 &raquo;</button>${adminButtons}</div></div>`;
            }).join('');
        }
        function viewReport(objectId) {
            const object = objects.find(obj => obj.id === objectId);
            if (!object) return;
            const reportHTML = `<h3 class="text-2xl font-bold text-red-400 mb-1">개체 번호: ${object.id}</h3><p class="text-lg text-gray-400 mb-4"><strong>등급:</strong> ${object.level}</p><hr class="border-gray-600 my-4"><p class="mb-2"><strong>특수 격리 절차:</strong> ${object.specialProcedures || '기록 없음.'}</p><p class="mb-2"><strong>설명:</strong> ${object.details || '기록 없음.'}</p>${object.appendix ? `<p class="font-bold mt-4 text-yellow-400">${object.appendix}</p>` : ''}<hr class="border-gray-600 my-8"><div class="flex justify-between items-center mb-4"><h4 class="text-xl font-bold text-gray-300">탐사 기록</h4>${adminMode ? `<button onclick="openNewLogModal('${object.id}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">+ 기록 추가</button>` : ''}</div><div class="space-y-4">${object.logs && object.logs.length > 0 ? object.logs.map(log => `<div class="bg-gray-900 p-3 rounded-lg border border-gray-700"><div class="flex justify-between items-start"><div><p class="font-semibold text-gray-400">${log.agent} - <span class="text-xs font-normal">${log.date}</span></p><p class="text-gray-300 mt-1">${log.content}</p></div>${adminMode ? `<div class="flex space-x-2 flex-shrink-0 ml-4"><button onclick="openEditLogModal('${object.id}', ${log.logId})" class="text-xs text-blue-400 hover:underline">수정</button><button onclick="openDeleteConfirm('log', '${object.id}', ${log.logId})" class="text-xs text-red-400 hover:underline">삭제</button></div>` : ''}</div></div>`).join('') : '<p class="text-gray-500">기록된 탐사 기록이 없습니다.</p>'}</div>`;
            reportContent.innerHTML = reportHTML;
            reportModal.classList.remove('hidden');
        }

        // --- 모달 관리 (이전과 동일) ---
        window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        window.openNewReportModal = () => { if (!adminMode) return; document.getElementById('formTitle').textContent = '신규 개체 보고서 등록'; reportForm.reset(); document.getElementById('editObjectId').value = ''; formModal.classList.remove('hidden'); document.getElementById('objectId').readOnly = false; };
        window.openEditReportModal = (objectId) => {
            const object = objects.find(obj => obj.id === objectId); if (!object) return;
            document.getElementById('formTitle').textContent = '개체 보고서 수정';
            document.getElementById('objectId').value = object.id || ''; document.getElementById('objectId').readOnly = true;
            document.getElementById('objectAlias').value = object.alias || ''; document.getElementById('objectLevel').value = object.level || '안전';
            document.getElementById('objectDescription').value = object.description || ''; document.getElementById('objectSpecialProcedures').value = object.specialProcedures || '';
            document.getElementById('objectDetails').value = object.details || ''; document.getElementById('objectAppendix').value = object.appendix || '';
            document.getElementById('editObjectId').value = object.id; formModal.classList.remove('hidden');
        };

        // --- Firebase 데이터 처리 ---
        reportForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const objectId = formData.get('objectId');
            if (!objectId) { alert("개체 번호는 필수입니다."); return; }
            
            const objectData = {
                id: objectId,
                alias: formData.get('objectAlias'), level: formData.get('objectLevel'),
                description: formData.get('objectDescription'), specialProcedures: formData.get('objectSpecialProcedures'),
                details: formData.get('objectDetails'), appendix: formData.get('objectAppendix'),
            };

            const docRef = doc(db, "kbsa-objects", objectId);
            const isEditing = formData.get('editObjectId');

            try {
                if (isEditing) {
                    const existingObject = objects.find(o => o.id === objectId);
                    objectData.logs = existingObject.logs || []; // 기존 로그 보존
                    await setDoc(docRef, objectData);
                } else {
                    objectData.logs = []; // 새 개체는 빈 로그로 시작
                    await setDoc(docRef, objectData);
                }
                closeModal('formModal');
            } catch (error) {
                console.error("Error writing document: ", error);
                alert("데이터 저장에 실패했습니다.");
            }
        });

        window.openNewLogModal = (objectId) => { document.getElementById('logFormTitle').textContent = '신규 탐사 기록 추가'; logForm.reset(); document.getElementById('logObjectId').value = objectId; document.getElementById('logId').value = ''; logFormModal.classList.remove('hidden'); };
        window.openEditLogModal = (objectId, logId) => {
            const object = objects.find(obj => obj.id === objectId); const log = object ? object.logs.find(l => l.logId === logId) : null; if (!log) return;
            document.getElementById('logFormTitle').textContent = '탐사 기록 수정'; document.getElementById('logObjectId').value = objectId;
            document.getElementById('logId').value = logId; document.getElementById('logAgent').value = log.agent;
            document.getElementById('logContentInput').value = log.content; logFormModal.classList.remove('hidden');
        };
        
        logForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const objectId = document.getElementById('logObjectId').value;
            const logId = document.getElementById('logId').value;
            const object = objects.find(obj => obj.id === objectId);
            if (!object) return;

            const logData = { agent: document.getElementById('logAgent').value, content: document.getElementById('logContentInput').value };
            let newLogs = [...(object.logs || [])];

            if (logId) { // 수정
                const logIndex = newLogs.findIndex(l => l.logId == logId);
                if (logIndex !== -1) {
                    newLogs[logIndex] = { ...newLogs[logIndex], ...logData };
                }
            } else { // 추가
                logData.logId = Date.now();
                logData.date = new Date().toISOString().split('T')[0];
                newLogs.push(logData);
            }
            
            const docRef = doc(db, "kbsa-objects", objectId);
            try {
                await updateDoc(docRef, { logs: newLogs });
                closeModal('logFormModal');
            } catch (error) {
                console.error("Error updating log: ", error);
                alert("탐사 기록 저장에 실패했습니다.");
            }
        });

        // --- 관리자 및 삭제 기능 (Firebase 연동) ---
        window.handleAdminClick = () => {
            if (adminMode) {
                adminMode = false; const btn = document.getElementById('adminLoginBtn');
                btn.textContent = '관리자 모드'; btn.classList.replace('border-green-500', 'border-yellow-500');
                btn.classList.replace('text-green-400', 'text-yellow-400');
                document.getElementById('addNewReportBtnNav').classList.add('hidden');
                document.getElementById('addNewEntityBtnMain').classList.add('hidden');
                document.getElementById('seed-data-btn').classList.add('hidden');
                renderObjects();
                if (!reportModal.classList.contains('hidden')) closeModal('reportModal');
            } else {
                openPasswordModal();
            }
        };
        const openPasswordModal = () => { document.getElementById('passwordError').classList.add('hidden'); document.getElementById('passwordInput').value = ''; passwordModal.classList.remove('hidden'); };
        window.checkPassword = () => {
            if (document.getElementById('passwordInput').value === '2923') {
                adminMode = true; closeModal('passwordModal');
                const btn = document.getElementById('adminLoginBtn');
                btn.textContent = '관리자 모드 활성'; btn.classList.replace('border-yellow-500', 'border-green-500');
                btn.classList.replace('text-yellow-400', 'text-green-400');
                document.getElementById('addNewReportBtnNav').classList.remove('hidden');
                document.getElementById('addNewEntityBtnMain').classList.remove('hidden');
                document.getElementById('seed-data-btn').classList.remove('hidden');
                renderObjects();
            } else { document.getElementById('passwordError').classList.remove('hidden'); }
        };
        window.openDeleteConfirm = (type, objectId, logId = null) => {
            itemToDelete = { type, objectId, logId };
            const text = type === 'object' ? `개체 [${objectId}] 보고서 전체를` : `[${objectId}] 보고서의 탐사 기록을`;
            document.getElementById('deleteConfirmText').textContent = `정말로 ${text} 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`;
            deleteConfirmModal.classList.remove('hidden');
        };
        window.confirmDelete = async () => {
            const { type, objectId, logId } = itemToDelete;
            try {
                if (type === 'object') {
                    await deleteDoc(doc(db, "kbsa-objects", objectId));
                } else if (type === 'log') {
                    const object = objects.find(obj => obj.id === objectId);
                    if (object) {
                        const newLogs = object.logs.filter(log => log.logId !== logId);
                        await updateDoc(doc(db, "kbsa-objects", objectId), { logs: newLogs });
                    }
                }
            } catch (error) {
                console.error("Delete failed: ", error);
                alert("삭제에 실패했습니다.");
            }
            itemToDelete = { type: null, objectId: null, logId: null };
            closeModal('deleteConfirmModal');
        };

        // --- 날짜 업데이트 ---
        function updateBriefingDate() {
            const today = new Date();
            const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            document.getElementById('briefing-date').textContent = `보안 브리핑: ${formattedDate}`;
        }
        
        // --- 초기 데이터 주입 함수 ---
        async function seedInitialData() {
            if (objects.length > 0) {
                alert("데이터베이스가 비어있지 않습니다. 초기 데이터 주입을 취소합니다.");
                return;
            }
            const batch = writeBatch(db);
            initialObjects.forEach(obj => {
                const docRef = doc(db, "kbsa-objects", obj.id);
                batch.set(docRef, obj);
            });
            try {
                await batch.commit();
                alert("초기 데이터 주입 성공!");
            } catch (error) {
                console.error("Error seeding data: ", error);
                alert("초기 데이터 주입에 실패했습니다.");
            }
        }

        // --- 앱 시작 ---
        document.querySelectorAll('a[href^="#"]').forEach(a => a.addEventListener('click', function(e) {
            e.preventDefault(); document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
        }));
        
        document.getElementById('seed-data-btn').addEventListener('click', seedInitialData);
        
        // Firestore 실시간 리스너 설정
        onSnapshot(objectsCollection, (snapshot) => {
            objects = snapshot.docs.map(doc => doc.data()).sort((a, b) => a.id.localeCompare(b.id));
            renderObjects();
            // 만약 보고서 모달이 열려있다면, 내용 새로고침
            if (!reportModal.classList.contains('hidden')) {
                const currentId = reportContent.querySelector('h3').textContent.replace('개체 번호: ', '');
                if (objects.some(o => o.id === currentId)) {
                    viewReport(currentId);
                } else {
                    closeModal('reportModal');
                }
            }
        });

        window.onload = () => {
            updateBriefingDate();
        };

        // 전역 스코프에 함수 할당 (인라인 onclick 이벤트에서 호출하기 위함)
        window.viewReport = viewReport;

    </script>
</body>
</html>

